<div class="container mt-5" *ngIf="user">
  <h2>Mi perfil</h2>

  <div *ngIf="!editMode">
    <p><strong>Usuario:</strong> {{ user.username }}</p>
    <p><strong>Email:</strong> {{ user.email }}</p>
    <button class="btn btn-primary" (click)="editMode = true">Editar perfil</button>
  </div>

  <div *ngIf="editMode">
    <form [formGroup]="profileForm" (ngSubmit)="saveChanges()">

      <div class="mb-3">
        <label for="username" class="form-label">Usuario</label>
        <input
          type="text"
          id="username"
          formControlName="username"
          class="form-control"
          [class.is-invalid]="f['username'].touched && f['username'].invalid"
        />
        <div *ngIf="f['username'].touched && f['username'].invalid" class="invalid-feedback">
          El usuario es obligatorio.
        </div>
      </div>

      <div class="mb-3">
        <label for="email" class="form-label">Correo electrónico</label>
        <input
          type="email"
          id="email"
          formControlName="email"
          class="form-control"
          [class.is-invalid]="f['email'].touched && f['email'].invalid"
        />
        <div *ngIf="f['email'].touched && f['email'].errors" class="invalid-feedback">
          <div *ngIf="f['email'].errors['required']">El correo es obligatorio.</div>
          <div *ngIf="f['email'].errors['email']">Introduce un correo válido.</div>
        </div>
      </div>

      <div class="mb-3">
        <label for="password" class="form-label">Contraseña</label>
        <input
          type="password"
          id="password"
          formControlName="password"
          class="form-control"
          [class.is-invalid]="
            (f['password'].touched && f['password'].invalid) ||
            (profileForm.errors?.['mismatch'] && (f['password'].touched || f['confirmPassword'].touched))
          "
          placeholder="Deja vacío para no cambiar"
        />
      </div>

      <div class="mb-3">
        <label for="confirmPassword" class="form-label">Confirmar contraseña</label>
        <input
          type="password"
          id="confirmPassword"
          formControlName="confirmPassword"
          class="form-control"
          [class.is-invalid]="
            (f['confirmPassword'].touched && f['confirmPassword'].invalid) ||
            (profileForm.errors?.['mismatch'] && (f['password'].touched || f['confirmPassword'].touched))
          "
          placeholder="Deja vacío para no cambiar"
        />
        <div *ngIf="profileForm.errors?.['mismatch'] && (f['confirmPassword'].touched || f['password'].touched)" class="invalid-feedback">
          Las contraseñas no coinciden.
        </div>
      </div>

      <button type="submit" class="btn btn-success" [disabled]="profileForm.invalid">Guardar cambios</button>
      <button type="button" class="btn btn-secondary ms-2" (click)="editMode = false">Cancelar</button>
    </form>
  </div>
</div>
